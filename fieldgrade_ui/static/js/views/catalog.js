import {
  apiExports,
  apiRegistryComponents,
  apiRegistryRemotes,
  apiRegistryVariants,
} from '../api.js';
import { downloadText } from '../components/download.js';

function $(id) { return document.getElementById(id); }

function clearEl(el) {
  if (!el) return;
  if (typeof el.replaceChildren === 'function') {
    el.replaceChildren();
    return;
  }
  while (el.firstChild) el.removeChild(el.firstChild);
}

function yamlDQ(v) {
  // YAML double-quoted scalars support JSON-style escaping; JSON.stringify is safe and deterministic.
  return JSON.stringify((v ?? '').toString());
}

function uniqSorted(values) {
  const s = new Set();
  for (const v of values) {
    const t = (v ?? '').toString().trim();
    if (t) s.add(t);
  }
  return Array.from(s).sort((a, b) => a.localeCompare(b));
}

function setSelectOptions(sel, options, { allLabel = '(all)', keepValue = true } = {}) {
  if (!sel) return;
  const prev = keepValue ? (sel.value || '') : '';
  clearEl(sel);

  const optAll = document.createElement('option');
  optAll.value = '';
  optAll.textContent = allLabel;
  sel.appendChild(optAll);

  for (const v of options) {
    const opt = document.createElement('option');
    opt.value = v;
    opt.textContent = v;
    sel.appendChild(opt);
  }

  if (keepValue && prev) {
    const hasPrev = Array.from(sel.options).some(o => o.value === prev);
    if (hasPrev) sel.value = prev;
  }
}

function show(el, yes) {
  if (!el) return;
  el.style.display = yes ? '' : 'none';
}

function getSelectValue(id) {
  const el = $(id);
  return el ? (el.value || '') : '';
}

function renderTable(wrap, columns, rows, onSelectRow) {
  clearEl(wrap);
  const table = document.createElement('table');
  table.className = 'jobsTable';

  const thead = document.createElement('thead');
  const trh = document.createElement('tr');
  for (const c of columns) {
    const th = document.createElement('th');
    th.textContent = c.title;
    trh.appendChild(th);
  }
  thead.appendChild(trh);
  table.appendChild(thead);

  const tbody = document.createElement('tbody');
  for (const row of rows) {
    const tr = document.createElement('tr');
    tr.tabIndex = 0;
    tr.addEventListener('click', () => onSelectRow(row));
    tr.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        onSelectRow(row);
      }
    });

    for (const c of columns) {
      const td = document.createElement('td');
      const v = c.value(row);
      td.textContent = (v ?? '').toString();
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  }
  table.appendChild(tbody);
  wrap.appendChild(table);
}

function variantPatchForExport(exportPath) {
  const base = (exportPath || '').split(/[/\\]/).pop() || 'export';
  const stem = base.replace(/\.json$/i, '');
  const variantId = stem.toLowerCase().replace(/[^a-z0-9]+/g, '_').replace(/^_+|_+$/g, '').slice(0, 64) || 'variant';
  const created = new Date().toISOString();

  return {
    filename: `variants_patch_${variantId}.yaml`,
    text: [
      '# PR-friendly patch snippet',
      '# Apply by inserting under `variants:` in `mite_ecology/registry/variants_v1.yaml`',
      '# Generated by Fieldgrade UI',
      '',
      `- variant_id: ${variantId}`,
      `  title: ${yamlDQ(stem)}`,
      `  description: ${yamlDQ(`Promoted from export ${base} (${created})`)}`,
      '  tags: [promoted, local-export]',
      '  template:',
      `    export_path: ${yamlDQ(exportPath)}`,
      '    studspec: null',
      '    tubespec: null',
      '',
    ].join('\n'),
  };
}

export function initCatalogView({ toast }) {
  const kindSel = $('catalogKind');
  const tableWrap = $('catalogTableWrap');
  const inspector = $('catalogInspectorPre');
  const hashEl = $('catalogHash');

  const compKindSel = $('catalogComponentsKind');
  const compRoleSel = $('catalogComponentsRole');
  const compRuntimeSel = $('catalogComponentsRuntime');

  const varTagSel = $('catalogVariantsTag');
  const varDeviceSel = $('catalogVariantsDevice');
  const varPolicySel = $('catalogVariantsPolicyMode');

  const exportsList = $('catalogExportsList');
  const btnRefresh = $('btnCatalogRefresh');
  const btnRefreshExports = $('btnCatalogRefreshExports');

  let cache = {
    components: null,
    variants: null,
    remotes: null,
    exports: null,
  };

  function setInspector(obj) {
    if (!inspector) return;
    inspector.textContent = obj ? JSON.stringify(obj, null, 2) : 'Select a row to inspect.';
  }

  function applyVisibility() {
    const kind = (kindSel && kindSel.value) || 'components';

    // Component filters
    show(compKindSel?.parentElement, kind === 'components');
    show(compRoleSel?.parentElement, kind === 'components');
    show(compRuntimeSel?.parentElement, kind === 'components');

    // Variant filters
    show(varTagSel?.parentElement, kind === 'variants');
    show(varDeviceSel?.parentElement, kind === 'variants');
    show(varPolicySel?.parentElement, kind === 'variants');
  }

  function rebuildFilterOptions() {
    const comps = (cache.components && cache.components.registry && cache.components.registry.components) || [];
    const vars = (cache.variants && cache.variants.registry && cache.variants.registry.variants) || [];

    // Components
    setSelectOptions(compKindSel, uniqSorted(comps.map(c => c.kind)), { allLabel: '(all kinds)' });
    setSelectOptions(compRoleSel, uniqSorted(comps.map(c => c.role)), { allLabel: '(all roles)' });
    setSelectOptions(compRuntimeSel, uniqSorted(comps.map(c => c.runtime)), { allLabel: '(all runtimes)' });

    // Variants
    const allTags = [];
    for (const v of vars) {
      if (Array.isArray(v.tags)) {
        for (const t of v.tags) allTags.push(t);
      } else if (typeof v.tags === 'string') {
        allTags.push(v.tags);
      }
    }
    setSelectOptions(varTagSel, uniqSorted(allTags), { allLabel: '(all tags)' });
    setSelectOptions(varDeviceSel, uniqSorted(vars.map(v => v.device)), { allLabel: '(all devices)' });
    setSelectOptions(varPolicySel, uniqSorted(vars.map(v => v.policy_mode)), { allLabel: '(all policy modes)' });
  }

  async function refreshRegistries() {
    try {
      const [c, v, r] = await Promise.all([
        apiRegistryComponents(),
        apiRegistryVariants(),
        apiRegistryRemotes(),
      ]);
      cache.components = c;
      cache.variants = v;
      cache.remotes = r;
      rebuildFilterOptions();
      render();
      toast('Catalog refreshed.', { kind: 'info', timeoutMs: 2000 });
    } catch (e) {
      toast('Catalog refresh failed: ' + (e?.message || e), { kind: 'error' });
    }
  }

  async function refreshExports() {
    try {
      const x = await apiExports();
      cache.exports = x;
      renderExports();
    } catch (e) {
      toast('Exports refresh failed: ' + (e?.message || e), { kind: 'error' });
    }
  }

  function renderExports() {
    if (!exportsList) return;
    clearEl(exportsList);
    const exportsArr = (cache.exports && cache.exports.exports) || [];
    for (const p of exportsArr) {
      const li = document.createElement('li');
      const row = document.createElement('div');
      row.className = 'row';

      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'primary';
      btn.textContent = 'Promote';
      btn.addEventListener('click', () => {
        const patch = variantPatchForExport(p);
        downloadText(patch.filename, patch.text, 'text/yaml');
        toast('Generated patch: ' + patch.filename, { kind: 'info', timeoutMs: 2500 });
      });

      const span = document.createElement('div');
      span.className = 'v';
      span.textContent = p;

      row.appendChild(btn);
      row.appendChild(span);
      li.appendChild(row);
      exportsList.appendChild(li);
    }
  }

  function render() {
    const kind = (kindSel && kindSel.value) || 'components';

    let payload = cache[kind];
    let rows = [];
    let sha = '';

    if (payload && payload.registry) {
      sha = payload.canonical_sha256 || '';
      if (kind === 'components') rows = payload.registry.components || [];
      if (kind === 'variants') rows = payload.registry.variants || [];
      if (kind === 'remotes') rows = payload.registry.remotes || [];
    }

    let filtered = rows;
    if (kind === 'components') {
      const k = getSelectValue('catalogComponentsKind');
      const role = getSelectValue('catalogComponentsRole');
      const rt = getSelectValue('catalogComponentsRuntime');
      filtered = rows.filter(r => {
        if (k && (r.kind || '') !== k) return false;
        if (role && (r.role || '') !== role) return false;
        if (rt && (r.runtime || '') !== rt) return false;
        return true;
      });
    } else if (kind === 'variants') {
      const tag = getSelectValue('catalogVariantsTag');
      const dev = getSelectValue('catalogVariantsDevice');
      const pm = getSelectValue('catalogVariantsPolicyMode');
      filtered = rows.filter(r => {
        if (dev && (r.device || '') !== dev) return false;
        if (pm && (r.policy_mode || '') !== pm) return false;
        if (tag) {
          const tags = Array.isArray(r.tags) ? r.tags : (typeof r.tags === 'string' ? [r.tags] : []);
          if (!tags.includes(tag)) return false;
        }
        return true;
      });
    }

    if (hashEl) {
      hashEl.textContent = sha ? `canonical_sha256: ${sha}` : '(no catalog loaded)';
    }

    if (kind === 'components') {
      renderTable(tableWrap,
        [
          { title: 'component_id', value: (r) => r.component_id || '' },
          { title: 'title', value: (r) => r.title || '' },
          { title: 'kind', value: (r) => r.kind || '' },
          { title: 'role', value: (r) => r.role || '' },
          { title: 'runtime', value: (r) => r.runtime || '' },
        ],
        filtered,
        setInspector
      );
    } else if (kind === 'variants') {
      renderTable(tableWrap,
        [
          { title: 'variant_id', value: (r) => r.variant_id || '' },
          { title: 'title', value: (r) => r.title || '' },
          { title: 'tags', value: (r) => Array.isArray(r.tags) ? r.tags.join(',') : (r.tags || '') },
          { title: 'device', value: (r) => r.device || '' },
          { title: 'policy_mode', value: (r) => r.policy_mode || '' },
        ],
        filtered,
        setInspector
      );
    } else {
      renderTable(tableWrap,
        [
          { title: 'remote_id', value: (r) => r.remote_id || '' },
          { title: 'enabled', value: (r) => (r.enabled === false ? 'false' : 'true') },
          { title: 'tuf_base', value: (r) => r.tuf_base || '' },
        ],
        filtered,
        setInspector
      );
    }
  }

  if (btnRefresh) btnRefresh.addEventListener('click', refreshRegistries);
  if (btnRefreshExports) btnRefreshExports.addEventListener('click', refreshExports);

  if (kindSel) kindSel.addEventListener('change', () => { applyVisibility(); render(); });
  for (const el of [compKindSel, compRoleSel, compRuntimeSel, varTagSel, varDeviceSel, varPolicySel]) {
    if (el) el.addEventListener('change', render);
  }

  setInspector(null);

  applyVisibility();

  // Initial load: show something deterministic if available.
  refreshRegistries();
  refreshExports();
}
