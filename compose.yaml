services:
  web:
    build:
      context: .
      dockerfile: Dockerfile
    command: ["python", "-m", "fieldgrade_ui", "serve"]
    healthcheck:
      test: ["CMD", "python", "-c", "import os, sys, urllib.request; req=urllib.request.Request('http://127.0.0.1:8787/healthz', headers={'X-API-Key': os.environ.get('FG_API_TOKEN','')}); urllib.request.urlopen(req, timeout=2).read(); sys.exit(0)"]
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 20s
    environment:
      FG_HOST: "0.0.0.0"
      FG_PORT: "8787"
      FG_WORKERS: "1"
      FG_ENABLE_WORKER: "0"
      FG_API_TOKEN: "${FG_API_TOKEN:?set FG_API_TOKEN in .env}"
      FG_MAX_UPLOAD_BYTES: "${FG_MAX_UPLOAD_BYTES:-0}"
      FG_CMD_TIMEOUT_S: "${FG_CMD_TIMEOUT_S:-600}"
    volumes:
      - fg_termite_runtime:/app/termite_fieldpack/runtime
      - fg_termite_artifacts:/app/termite_fieldpack/artifacts
      - fg_mite_runtime:/app/mite_ecology/runtime
      - fg_mite_artifacts:/app/mite_ecology/artifacts
      - fg_ui_runtime:/app/fieldgrade_ui/runtime

  worker:
    build:
      context: .
      dockerfile: Dockerfile
    command: ["python", "-m", "fieldgrade_ui", "worker"]
    environment:
      FG_WORKER_POLL: "${FG_WORKER_POLL:-1.0}"
      FG_CMD_TIMEOUT_S: "${FG_CMD_TIMEOUT_S:-600}"
    volumes:
      - fg_termite_runtime:/app/termite_fieldpack/runtime
      - fg_termite_artifacts:/app/termite_fieldpack/artifacts
      - fg_mite_runtime:/app/mite_ecology/runtime
      - fg_mite_artifacts:/app/mite_ecology/artifacts
      - fg_ui_runtime:/app/fieldgrade_ui/runtime

volumes:
  fg_termite_runtime: {}
  fg_termite_artifacts: {}
  fg_mite_runtime: {}
  fg_mite_artifacts: {}
  fg_ui_runtime: {}
